<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCM 2026 Problem B - ÂõæË°®ÁîªÂªä</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #2a2a3a;
            --success: #22c55e;
            --warning: #f59e0b;
            --sidebar-width: 280px;
            --sidebar-collapsed: 50px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent) 0%, #a855f7 100%);
            border-radius: 4px;
            border: 2px solid var(--bg-primary);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--accent-hover) 0%, #c084fc 100%);
        }
        ::-webkit-scrollbar-corner {
            background: var(--bg-primary);
        }
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-primary);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
        }

        .header-left { display: flex; align-items: center; gap: 1rem; }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .toggle-sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .toggle-sidebar:hover { border-color: var(--accent); color: var(--accent); }

        .search-container { flex: 1; max-width: 450px; margin: 0 1.5rem; }
        .search-wrapper { position: relative; }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.9rem; pointer-events: none; }
        .search-box {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 2.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .search-box:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .search-box::placeholder { color: var(--text-secondary); }
        .search-clear {
            position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--text-secondary);
            font-size: 1.2rem; cursor: pointer; padding: 0.25rem;
            display: none;
        }
        .search-clear.visible { display: block; }

        .header-right { display: flex; align-items: center; gap: 1rem; }

        .view-switcher { display: flex; gap: 0.25rem; background: var(--bg-card); border-radius: 8px; padding: 0.2rem; border: 1px solid var(--border); }
        .view-btn {
            padding: 0.4rem 0.75rem; font-size: 0.75rem;
            background: transparent; border: none; border-radius: 6px;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
        }
        .view-btn.active { background: var(--accent); color: white; }
        .view-btn:not(.active):hover { color: var(--text-primary); }

        .header-stats { font-size: 0.75rem; color: var(--text-secondary); display: flex; gap: 1rem; }

        /* App Layout */
        .app-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 120px;
            max-width: 400px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.75rem;
            flex-shrink: 0;
            position: relative;
        }

        /* Resizer Handle */
        .resizer {
            width: 6px;
            background: transparent;
            cursor: col-resize;
            position: absolute;
            top: 0;
            bottom: 0;
            z-index: 10;
            transition: background 0.2s;
        }
        .resizer:hover, .resizer.active {
            background: var(--accent);
        }
        .resizer-left { right: -3px; }
        .resizer-right { left: -3px; }
        .resizer-h {
            height: 8px;
            background: var(--border);
            cursor: row-resize;
            flex-shrink: 0;
            transition: background 0.2s;
            border-radius: 4px;
            margin: 4px 0;
        }
        .resizer-h:hover, .resizer-h.active {
            background: var(--accent);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
            padding: 0.75rem 0.5rem;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-content { opacity: 0; pointer-events: none; }
        .sidebar.collapsed .sidebar-title { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 0.7rem; }

        .sidebar-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.3s;
        }

        .sidebar-content { transition: opacity 0.2s; }

        .theme-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.6rem; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; font-size: 0.85rem;
        }
        .theme-item:hover { background: var(--bg-card); }
        .theme-item.active { background: rgba(99, 102, 241, 0.15); color: var(--accent); }
        .theme-item .icon { font-size: 1rem; }
        .theme-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .theme-item .count { font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-primary); padding: 0.15rem 0.4rem; border-radius: 9999px; }

        .tag-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .tag {
            padding: 0.3rem 0.55rem; font-size: 0.8rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 9999px; cursor: pointer; transition: all 0.2s;
        }
        .tag:hover, .tag.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); color: var(--accent); }

        /* Main Gallery */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-primary);
        }

        .gallery-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);
        }
        .gallery-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .gallery-count { font-size: 0.75rem; color: var(--text-secondary); }

        /* Masonry Grid (ÁÄëÂ∏ÉÊµÅ) */
        .gallery-masonry {
            column-count: 4;
            column-gap: 1rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .gallery-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Image Card */
        .image-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            break-inside: avoid;
            margin-bottom: 1rem;
        }

        .image-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.25);
            z-index: 10;
        }

        .image-card img {
            width: 100%;
            display: block;
            transition: transform 0.3s;
        }

        /* GridÊ®°ÂºèÂõ∫ÂÆöÈ´òÂ∫¶ */
        .gallery-grid .image-card img { height: 130px; object-fit: cover; }
        /* MasonryÊ®°ÂºèËá™ÈÄÇÂ∫îÈ´òÂ∫¶ */
        .gallery-masonry .image-card img { height: auto; }
        /* ListÊ®°Âºè */
        .gallery-list .image-card { display: flex; flex-direction: row; }
        .gallery-list .image-card img { width: 120px; height: 80px; object-fit: cover; flex-shrink: 0; }
        .gallery-list .image-card-info { flex: 1; }

        .image-card:hover img { transform: scale(1.05); }

        .add-to-board-btn {
            position: absolute; top: 0.4rem; right: 0.4rem;
            width: 26px; height: 26px;
            background: rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; color: white;
            font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .add-to-board-btn:hover { background: var(--accent); border-color: var(--accent); transform: scale(1.1); }
        .add-to-board-btn.added { background: var(--success); border-color: var(--success); }

        .image-card-info { padding: 0.75rem; }
        .image-card-title {
            font-size: 0.8rem; font-weight: 600;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            margin-bottom: 0.2rem;
        }
        .image-card-subtitle {
            font-size: 0.75rem; color: var(--text-secondary);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            margin-bottom: 0.25rem;
        }
        .image-card-source { font-size: 0.75rem; color: var(--text-secondary); }
        .image-card-theme {
            font-size: 0.75rem; color: #a5b4fc; font-weight: 500;
            margin-top: 0.35rem; margin-bottom: 0.25rem;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .image-card-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; overflow: hidden; max-height: 2.5em; margin-top: 0.2rem; }
        .card-tag {
            font-size: 0.65rem; padding: 0.15rem 0.45rem;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 9999px; color: #cbd5e1;
            white-space: nowrap;
        }
        /* AIÁîüÊàêÊ†áÁ≠æÁâπÊÆäÊ†∑Âºè */
        .card-tag.ai-tag {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(239, 68, 68, 0.3));
            border: 1px solid rgba(245, 158, 11, 0.6);
            color: #fbbf24;
            font-weight: 600;
        }
        /* AIÁîüÊàêÂõæÁâáÂç°ÁâáÊ†∑Âºè */
        .image-card.ai-generated {
            border: 2px solid transparent;
            background-image: linear-gradient(var(--bg-card), var(--bg-card)),
                              linear-gradient(135deg, #f59e0b, #ef4444, #a855f7, #3b82f6);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }
        .image-card.ai-generated::before {
            content: 'ü§ñ AI';
            position: absolute;
            top: 8px; right: 8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: white;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .highlight { background: rgba(99, 102, 241, 0.3); color: var(--accent); padding: 0 0.15rem; border-radius: 2px; }

        /* Whiteboard Panel */
        .whiteboard-panel {
            width: 280px;
            min-width: 180px;
            max-width: 450px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
        }

        .whiteboard-panel.collapsed { width: 48px; }
        .whiteboard-panel.collapsed .whiteboard-content,
        .whiteboard-panel.collapsed .whiteboard-actions { display: none; }
        .whiteboard-panel.collapsed .whiteboard-title { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 0.7rem; }

        .whiteboard-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .whiteboard-title { font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
        .whiteboard-count { font-size: 0.7rem; color: var(--text-secondary); }
        .whiteboard-actions { display: flex; gap: 0.4rem; }
        .whiteboard-btn {
            padding: 0.35rem 0.65rem; font-size: 0.7rem;
            background: var(--accent); border: none; border-radius: 5px;
            color: white; cursor: pointer; transition: all 0.2s;
        }
        .whiteboard-btn:hover { background: var(--accent-hover); }
        .whiteboard-btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .whiteboard-btn.secondary:hover { border-color: var(--accent); color: var(--accent); }

        .whiteboard-content { flex: 1; overflow-y: auto; padding: 0.5rem; }

        .board-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 0.5rem;
            overflow: hidden; position: relative; transition: all 0.2s;
        }
        .board-item:hover { border-color: var(--accent); }
        .board-item img { width: 100%; height: 60px; object-fit: cover; }
        .board-item .remove-btn {
            position: absolute; top: 0.25rem; right: 0.25rem;
            width: 20px; height: 20px;
            background: rgba(239, 68, 68, 0.9); border: none; border-radius: 50%;
            color: white; font-size: 0.8rem; cursor: pointer;
        }
        .board-item-info { padding: 0.4rem; }
        .board-item-theme { font-size: 0.55rem; color: var(--text-secondary); }
        .board-item-title { font-size: 0.65rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .empty-state p { font-size: 0.8rem; }

        /* Modal */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center;
            z-index: 200; backdrop-filter: blur(8px);
        }
        .modal.active { display: flex; }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem;
            background: none; border: none; color: white;
            font-size: 2.5rem; cursor: pointer; z-index: 201;
        }
        .modal-content {
            display: flex; gap: 1.5rem; max-width: 90vw; max-height: 85vh;
            background: var(--bg-secondary); border-radius: 12px;
            overflow: hidden; border: 1px solid var(--border);
        }
        .modal-image { max-height: 85vh; max-width: 60vw; object-fit: contain; }
        .modal-info { width: 320px; padding: 1.5rem; overflow-y: auto; }
        .modal-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; line-height: 1.4; }
        .modal-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .modal-meta-item { background: var(--bg-card); padding: 0.6rem; border-radius: 6px; }
        .modal-meta-label { display: block; font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .modal-meta-value { font-size: 0.8rem; word-break: break-word; }
        .modal-meta-value a { color: var(--accent); text-decoration: none; }
        .modal-meta-value a:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 1400px) { .gallery-masonry { column-count: 4; } }
        @media (max-width: 1100px) { .gallery-masonry { column-count: 3; } }
        @media (max-width: 800px) {
            .gallery-masonry { column-count: 2; }
            .sidebar { position: fixed; left: 0; top: 56px; bottom: 0; z-index: 50; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .whiteboard-panel { width: 240px; }
        }

        /* Keyboard hints */
        kbd { background: var(--bg-card); border: 1px solid var(--border); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.65rem; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="toggle-sidebar" id="toggleSidebar" title="ÊäòÂè†/Â±ïÂºÄ‰æßËæπÊ†è">‚ò∞</button>
            <h1>üåô MCM 2026 - ÂõæË°®Á¥†ÊùêÁîªÂªä</h1>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-box" id="searchInput" placeholder="ÊêúÁ¥¢ÂõæÁâá... (Ctrl+K)" autocomplete="off">
                <button class="search-clear" id="searchClear">√ó</button>
            </div>
        </div>
        <div class="header-right">
            <div class="view-switcher">
                <button class="view-btn" data-view="grid" title="ÁΩëÊ†ºËßÜÂõæ">‚ñ¶ ÁΩëÊ†º</button>
                <button class="view-btn active" data-view="masonry" title="ÁÄëÂ∏ÉÊµÅËßÜÂõæ">‚ó´ ÁÄëÂ∏ÉÊµÅ</button>
                <button class="view-btn" data-view="list" title="ÂàóË°®ËßÜÂõæ">‚ò∞ ÂàóË°®</button>
            </div>
            <div class="header-stats">
                <span id="totalImages">0 Âº†</span>
                <span id="totalThemes">0 ‰∏ªÈ¢ò</span>
            </div>
        </div>
    </header>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="resizer resizer-left" id="sidebarResizer"></div>
            <div class="sidebar-content" style="display: flex; flex-direction: column; height: 100%;">
                <div class="tag-section" id="tagSection" style="margin-top:0; padding-top:0; border-top:none; flex: 4; min-height: 80px; overflow: hidden;">
                    <div class="sidebar-title">üè∑Ô∏è Ê†áÁ≠æÁ≠õÈÄâ</div>
                    <div class="tag-list" id="tagList" style="max-height: calc(100% - 30px); overflow-y: auto;"></div>
                </div>
                <div class="resizer-h" id="sectionResizer"></div>
                <div class="theme-section" id="themeSection" style="flex: 6; min-height: 80px; overflow: hidden;">
                    <div class="sidebar-title">üìÅ ‰∏ªÈ¢òÂàÜÁ±ª</div>
                    <div class="theme-list" id="themeList" style="max-height: calc(100% - 30px); overflow-y: auto;"></div>
                </div>
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            <div class="gallery-header">
                <div class="gallery-title">
                    <span id="galleryTitle">ÊâÄÊúâÂõæÁâá</span>
                    <span class="gallery-count" id="galleryCount"></span>
                </div>
            </div>
            <div class="gallery-masonry" id="galleryGrid"></div>
        </main>

        <aside class="whiteboard-panel" id="whiteboardPanel">
            <div class="resizer resizer-right" id="whiteboardResizer"></div>
            <div class="whiteboard-header">
                <div>
                    <div class="whiteboard-title">üìã ÁôΩÊùø</div>
                    <div class="whiteboard-count" id="boardCount">0 / 30</div>
                </div>
                <div class="whiteboard-actions">
                    <button class="whiteboard-btn secondary" onclick="clearBoard()">Ê∏ÖÁ©∫</button>
                    <button class="whiteboard-btn" onclick="exportBoard()">ÂØºÂá∫</button>
                </div>
            </div>
            <div class="whiteboard-content" id="boardContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìå</div>
                    <p>ÁÇπÂáªÂõæÁâá + Ê∑ªÂä†</p>
                </div>
            </div>
        </aside>
    </div>

    <div class="modal" id="imageModal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-content">
            <img src="" alt="" class="modal-image" id="modalImage">
            <div class="modal-info">
                <h3 class="modal-title" id="modalTitle"></h3>
                <div class="modal-meta" id="modalMeta"></div>
            </div>
        </div>
    </div>

    <script src="gallery_data.js"></script>
    <script>
        let allImages = GALLERY_DATA.images || [];
        let boardImages = [];
        let selectedTheme = null;
        let selectedTags = new Set();
        let currentView = 'masonry';
        let searchQuery = '';
        let sidebarCollapsed = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('totalImages').textContent = `${allImages.length} Âº†`;
            document.getElementById('totalThemes').textContent = `${GALLERY_DATA.themes.length} ‰∏ªÈ¢ò`;
            
            renderThemes();
            renderTags();
            renderGallery();
            setupEventListeners();
            setupResizers();
        });

        // Resizable Panels
        function setupResizers() {
            const sidebar = document.getElementById('sidebar');
            const whiteboard = document.getElementById('whiteboardPanel');
            const sidebarResizer = document.getElementById('sidebarResizer');
            const whiteboardResizer = document.getElementById('whiteboardResizer');
            
            let isResizing = false;
            let currentResizer = null;
            let startX, startWidth;
            
            function startResize(e, resizer, panel, isLeft) {
                isResizing = true;
                currentResizer = resizer;
                startX = e.clientX;
                startWidth = panel.offsetWidth;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                const onMouseMove = (e) => {
                    if (!isResizing) return;
                    const delta = isLeft ? (e.clientX - startX) : (startX - e.clientX);
                    const newWidth = Math.max(120, Math.min(450, startWidth + delta));
                    panel.style.width = newWidth + 'px';
                };
                
                const onMouseUp = () => {
                    isResizing = false;
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
            
            sidebarResizer.addEventListener('mousedown', (e) => startResize(e, sidebarResizer, sidebar, true));
            whiteboardResizer.addEventListener('mousedown', (e) => startResize(e, whiteboardResizer, whiteboard, false));
        }

        function setupEventListeners() {
            // Search
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            let debounceTimer;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    searchQuery = e.target.value.trim();
                    searchClear.classList.toggle('visible', searchQuery.length > 0);
                    renderGallery();
                }, 150);
            });
            
            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                searchClear.classList.remove('visible');
                renderGallery();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    searchInput.focus();
                }
                if (e.key === 'Escape') {
                    closeModal();
                    searchInput.blur();
                }
            });
            
            // View switcher
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    renderGallery();
                });
            });
            
            // Toggle sidebar
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');
                sidebarCollapsed = !sidebarCollapsed;
            });
            
            // Modal close on background click
            document.getElementById('imageModal').addEventListener('click', (e) => {
                if (e.target.id === 'imageModal') closeModal();
            });
        }

        function renderThemes() {
            const container = document.getElementById('themeList');
            
            // All themes option
            const allItem = document.createElement('div');
            allItem.className = `theme-item ${!selectedTheme ? 'active' : ''}`;
            allItem.innerHTML = `<span class="icon">üåê</span><span class="name">ÂÖ®ÈÉ®</span><span class="count">${allImages.length}</span>`;
            allItem.onclick = () => { selectedTheme = null; renderGallery(); renderThemes(); };
            container.appendChild(allItem);
            
            GALLERY_DATA.themes.forEach(theme => {
                const item = document.createElement('div');
                item.className = `theme-item ${selectedTheme === theme.id ? 'active' : ''}`;
                item.innerHTML = `<span class="icon">${theme.icon}</span><span class="name">${theme.name}</span><span class="count">${theme.count}</span>`;
                item.onclick = () => { selectedTheme = theme.id; renderGallery(); renderThemes(); };
                container.appendChild(item);
            });
        }

        function renderTags() {
            const container = document.getElementById('tagList');
            const tagCounts = {};
            allImages.forEach(img => (img.tags || []).forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1));
            
            Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 25).forEach(([tag, count]) => {
                const span = document.createElement('span');
                span.className = `tag ${selectedTags.has(tag) ? 'active' : ''}`;
                span.textContent = `${tag} (${count})`;
                span.onclick = () => {
                    selectedTags.has(tag) ? selectedTags.delete(tag) : selectedTags.add(tag);
                    renderGallery();
                    renderTags();
                };
                container.appendChild(span);
            });
        }

        // Fuzzy search
        function fuzzyMatch(text, query) {
            if (!text || !query) return { match: false, score: 0 };
            text = text.toLowerCase();
            query = query.toLowerCase().trim();
            if (text.includes(query)) return { match: true, score: 100 - text.indexOf(query) };
            const words = query.split(/\s+/);
            if (words.every(w => text.includes(w))) return { match: true, score: 80 };
            return { match: false, score: 0 };
        }

        function searchImages(query) {
            if (!query) return allImages.map(img => ({ ...img, searchScore: 0 }));
            return allImages.filter(img => {
                const titleMatch = fuzzyMatch(img.title || '', query);
                const titleEnMatch = fuzzyMatch(img.titleEn || '', query);
                const themeMatch = fuzzyMatch(img.themeName || '', query);
                const descMatch = fuzzyMatch(img.description || '', query);
                return titleMatch.match || titleEnMatch.match || themeMatch.match || descMatch.match;
            });
        }

        function renderGallery() {
            const container = document.getElementById('galleryGrid');
            
            // Apply view class
            container.className = currentView === 'masonry' ? 'gallery-masonry' : 
                                  currentView === 'list' ? 'gallery-list' : 'gallery-grid';
            
            let filtered = searchQuery ? searchImages(searchQuery) : allImages;
            if (selectedTheme) filtered = filtered.filter(img => img.theme === selectedTheme);
            if (selectedTags.size > 0) filtered = filtered.filter(img => [...selectedTags].some(t => (img.tags || []).includes(t)));
            
            // Update title
            document.getElementById('galleryTitle').textContent = selectedTheme 
                ? GALLERY_DATA.themes.find(t => t.id === selectedTheme)?.name || 'ÂÖ®ÈÉ®'
                : 'ÊâÄÊúâÂõæÁâá';
            document.getElementById('galleryCount').textContent = `(${filtered.length}Âº†)`;
            
            container.innerHTML = '';
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÂõæÁâá</p></div>`;
                return;
            }
            
            // Limit for performance
            filtered.slice(0, 300).forEach(img => {
                const card = createImageCard(img, searchQuery);
                container.appendChild(card);
            });
        }

        function createImageCard(img, query) {
            const div = document.createElement('div');
            div.className = 'image-card' + (img.isAIGenerated ? ' ai-generated' : '');
            const isInBoard = boardImages.some(b => b.id === img.id);
            const imgSrc = img.imagePath || 'placeholder.png';
            
            let title = img.title || '';
            let titleEn = img.titleEn || '';
            if (query) {
                title = highlightText(title, query);
                titleEn = highlightText(titleEn, query);
            }
            
            // ÁîüÊàêÊ†áÁ≠æ HTMLÔºàÊúÄÂ§öÊòæÁ§∫3‰∏™ÔºâÔºåAIÁîüÊàêÊ†áÁ≠æÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
            const tags = (img.tags || []).slice(0, 3);
            const tagsHtml = tags.map(t => {
                const isAITag = t === 'AIÁîüÊàê';
                return `<span class="card-tag${isAITag ? ' ai-tag' : ''}">${t}</span>`;
            }).join('');
            
            div.innerHTML = `
                <img src="${imgSrc}" alt="${img.title}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22180%22 height=%22120%22><rect fill=%22%231a1a25%22 width=%22180%22 height=%22120%22/><text fill=%22%2394a3b8%22 x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2224%22>üìä</text></svg>'">
                <button class="add-to-board-btn ${isInBoard ? 'added' : ''}" onclick="event.stopPropagation(); toggleBoard('${img.id}')">${isInBoard ? '‚úì' : '+'}</button>
                <div class="image-card-info">
                    <div class="image-card-title">${title}</div>
                    <div class="image-card-subtitle">${titleEn}</div>
                    <div class="image-card-theme">üìÅ ${img.themeName || ''}</div>
                    <div class="image-card-tags">${tagsHtml}</div>
                </div>
            `;
            div.onclick = () => openModal(img);
            return div;
        }

        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function toggleBoard(imgId) {
            const img = allImages.find(i => i.id === imgId);
            if (!img) return;
            const idx = boardImages.findIndex(b => b.id === imgId);
            if (idx >= 0) boardImages.splice(idx, 1);
            else if (boardImages.length < 30) boardImages.push(img);
            renderGallery();
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('boardContent');
            document.getElementById('boardCount').textContent = `${boardImages.length} / 30`;
            
            if (boardImages.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìå</div><p>ÁÇπÂáªÂõæÁâá + Ê∑ªÂä†</p></div>`;
                return;
            }
            
            container.innerHTML = '';
            boardImages.forEach(img => {
                const div = document.createElement('div');
                div.className = 'board-item';
                div.innerHTML = `
                    <img src="${img.imagePath || 'placeholder.png'}" alt="${img.title}" onerror="this.style.display='none'">
                    <button class="remove-btn" onclick="toggleBoard('${img.id}')">√ó</button>
                    <div class="board-item-info">
                        <div class="board-item-theme">${img.themeName}</div>
                        <div class="board-item-title">${img.title}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function clearBoard() {
            if (confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÁôΩÊùøÔºü')) {
                boardImages = [];
                renderGallery();
                renderBoard();
            }
        }

        function exportBoard() {
            if (boardImages.length === 0) { alert('ÁôΩÊùø‰∏∫Á©∫'); return; }
            
            let md = '# MCM 2026 Problem B - ÂõæÁâáÂ±ïÁ§∫\n\n';
            md += `> ÂØºÂá∫Êó∂Èó¥: ${new Date().toLocaleString()}\n\n`;
            md += `## Â∑≤ÈÄâÂõæÁâá (${boardImages.length}Âº†)\n\n`;
            
            const grouped = {};
            boardImages.forEach(img => {
                const t = img.themeName || 'Other';
                if (!grouped[t]) grouped[t] = [];
                grouped[t].push(img);
            });
            
            Object.entries(grouped).forEach(([theme, imgs]) => {
                md += `### ${theme}\n\n`;
                imgs.forEach(img => {
                    md += `- **${img.title}**\n`;
                    md += `  - ÊèèËø∞: ${img.description || 'ÊöÇÊó†'}\n`;
                    md += `  - Êñá‰ª∂: \`${img.imagePath}\`\n`;
                    if (img.sourceUrl) md += `  - Êù•Ê∫ê: [${img.source}](${img.sourceUrl})\n`;
                    else md += `  - Êù•Ê∫ê: ${img.source || 'N/A'}\n`;
                    md += `\n`;
                });
            });
            
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mcm-gallery-export.md';
            a.click();
        }

        function openModal(img) {
            document.getElementById('modalImage').src = img.imagePath || '';
            document.getElementById('modalTitle').innerHTML = `
                <span style="font-size:1.1rem;">${img.title}</span>
                <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem;font-weight:normal;">${img.titleEn || ''}</div>
            `;
            
            const desc = img.description || 'ÊöÇÊó†ÊèèËø∞';
            document.getElementById('modalMeta').innerHTML = `
                <div class="modal-meta-item" style="grid-column: span 2;">
                    <span class="modal-meta-label">üìù ÊèèËø∞</span>
                    <span class="modal-meta-value" style="font-size: 0.8rem; line-height: 1.5;">${desc}</span>
                </div>
                <div class="modal-meta-item"><span class="modal-meta-label">‰∏ªÈ¢ò</span><span class="modal-meta-value">${img.themeName}</span></div>
                <div class="modal-meta-item"><span class="modal-meta-label">Êù•Ê∫ê</span><span class="modal-meta-value">${img.sourceUrl ? `<a href="${img.sourceUrl}" target="_blank">${img.source}</a>` : img.source}</span></div>
                <div class="modal-meta-item"><span class="modal-meta-label">ËÆ∏ÂèØ</span><span class="modal-meta-value">${img.license || 'N/A'}</span></div>
                <div class="modal-meta-item"><span class="modal-meta-label">Êó•Êúü</span><span class="modal-meta-value">${img.date || 'N/A'}</span></div>
            `;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // ‰æßËæπÊ†èÂÜÖÊ†áÁ≠æ/‰∏ªÈ¢òÂå∫ÂüüÈ´òÂ∫¶Ë∞ÉÊï¥
        (function() {
            const resizer = document.getElementById('sectionResizer');
            const tagSection = document.getElementById('tagSection');
            const themeSection = document.getElementById('themeSection');
            const sidebar = document.querySelector('.sidebar-content');
            
            if (!resizer || !tagSection || !themeSection) return;
            
            let startY, startTagHeight, startThemeHeight;
            
            resizer.addEventListener('mousedown', function(e) {
                startY = e.clientY;
                startTagHeight = tagSection.offsetHeight;
                startThemeHeight = themeSection.offsetHeight;
                resizer.classList.add('active');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resize(e) {
                const delta = e.clientY - startY;
                const newTagHeight = startTagHeight + delta;
                const newThemeHeight = startThemeHeight - delta;
                
                if (newTagHeight >= 80 && newThemeHeight >= 80) {
                    tagSection.style.flex = 'none';
                    tagSection.style.height = newTagHeight + 'px';
                    themeSection.style.flex = '1';
                }
            }
            
            function stopResize() {
                resizer.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        })();
    </script>
</body>
</html>
